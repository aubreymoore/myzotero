(function($){window.TWP=window.TWP||{};TWP.Identity=TWP.Identity||{};TWP.Identity.swgCheckRequired=true;window.TWP_SWG=function(){var SWG_CHECK_ENTITLEMENT="/swg/check-entitlement";var SWG_GRANT_ACCESS="/swg/grant-access";var WAPO_ACCT_MGMT_COOKIE="/person/get-actmgmt-cookie";var SWG_TOAST_DEFERRED_ACCOUNT_CREATION="toastDeferredAccountCreation";var SWG_TOAST_DEFERRED_ACCOUNT_CREATION_DECLINED="toastDeferredAccountCreationDeclined";var SWG_OMNITURE_CONSTENT_TO_LINK_OR_CREATE="consentToLinkOrCreate";
var SWG_SIGNED_IN="signedIn";var init=function(){if(document.cookie.match("rplsb\x3d1")!==null||document.cookie.match("wp_lwg_out\x3d1")!==null){TWP.Identity.swgChecked=true;return false}document.addEventListener("onTwpMeterComplete",function(){if(!TWP.Identity.paywall||TWP.Identity.paywall&&!TWP.Identity.paywall.pwresp||TWP.Identity.paywall.pwresp&&TWP.Identity.paywall.pwresp.action<3){TWP.Identity.swgChecked=true;return false}checkGoogleUserEntitlements();startSwgScript()})};function checkGoogleUserEntitlements(){(self.SUBSCRIPTIONS=
self.SUBSCRIPTIONS||[]).push(function(subscriptions){subscriptions.init("washingtonpost.com:basic");subscriptions.getEntitlements().then(function(response){if(response&&response.entitlements&&response.entitlements.length>0){var url=window.location.host.indexOf("digitalink.com")!==-1?"https://subscribe.digitalink.com":"https://subscribe.washingtonpost.com";var data=response;subscriptions.setOnEntitlementsResponse(function(entitlementsPromise){entitlementsPromise.then(function(entitlements){entitlements.ack();
if(entitlements.enablesThis())if(window.fetch){var accountPromise=buildSwgCheckEntitlementFetch(url,data);subscriptions.waitForSubscriptionLookup(accountPromise).then(function(data){TWP.Identity.swgChecked=true;if(data.status==="SUCCESS")if(!data.createAccount)subscriptions.showLoginNotification().then(function(){fetchWapoAcctMgmt(url).then(function(wapoAcctMgmtCookie){sendSWGOmniture(SWG_SIGNED_IN,wapoAcctMgmtCookie);reRenderIdntMenu()})});else{sendSWGOmniture(SWG_TOAST_DEFERRED_ACCOUNT_CREATION);
subscriptions.completeDeferredAccountCreation({entitlements:entitlements,consent:true}).then(function(response){var accountCreationPromise=buildSwgGrantAccessFetch(url,response);accountCreationPromise.then(function(){fetchWapoAcctMgmt(url).then(function(wapoAcctMgmtCookie){sendSWGOmniture(SWG_OMNITURE_CONSTENT_TO_LINK_OR_CREATE,wapoAcctMgmtCookie);response.complete().then(function(){reRenderIdntMenu()})})})})["catch"](function(err){sendSWGOmniture(SWG_TOAST_DEFERRED_ACCOUNT_CREATION_DECLINED);window.console.error(err)})}else TWP.Identity._openOverlay()})}else{var xhr=
buildSwgCheckEntitlementXHR(url,data);xhr.onload=function(){TWP.Identity.swgChecked=true;try{var data=JSON.parse(xhr.responseText);if(!data.createAccount)subscriptions.showLoginNotification().then(function(){var wapoAcctMgmtXHR=xhrWapoAcctMgmt(url);wapoAcctMgmtXHR.onload=function(){sendSWGOmniture(SWG_SIGNED_IN,xhr.responseText);reRenderIdntMenu()}});else{sendSWGOmniture(SWG_TOAST_DEFERRED_ACCOUNT_CREATION);subscriptions.completeDeferredAccountCreation({entitlements:entitlements,consent:true}).then(function(response){var accountCreationXHR=
buildSwgGrantAccessXHR(url,response);accountCreationXHR.onload=function(){var wapoAcctMgmtXHR=xhrWapoAcctMgmt(url);wapoAcctMgmtXHR.onload=function(){sendSWGOmniture(SWG_OMNITURE_CONSTENT_TO_LINK_OR_CREATE,xhr.responseText);response.complete().then(function(){reRenderIdntMenu()})}}})["catch"](function(err){sendSWGOmniture(SWG_TOAST_DEFERRED_ACCOUNT_CREATION_DECLINED);window.console.error(err)})}}catch(e){console.error("Unable to parse check-entitlement json",e)}}}})})}else{TWP.Identity.swgChecked=
true;TWP.Identity._openOverlay()}},function(){TWP.Identity.swgChecked=true;TWP.Identity._openOverlay()})})}function buildSwgCheckEntitlementFetch(url,data){return window.fetch(url+SWG_CHECK_ENTITLEMENT,{method:"POST",mode:"cors",credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(data)}).then(function(response){return response.json()})["catch"](function(){console.error("Unknown error when calling check-entitlements");TWP.Identity.swgChecked=
true})}function transformPayload(data){try{var userData=data.userData;var purchaseData=data.purchaseData.raw.data&&JSON.parse(data.purchaseData.raw.data)||JSON.parse(data.purchaseData.raw);return{user:{id:userData.id,email:userData.email,emailVerified:userData.emailVerified,name:userData.name,givenName:userData.givenName,familyName:userData.familyName,pictureUrl:userData.pictureUrl},packageName:purchaseData.packageName,productId:purchaseData.productId,purchaseToken:purchaseData.purchaseToken}}catch(e){console.error(e);
return false}}function buildSwgGrantAccessFetch(url,data){var payload=transformPayload(data);return window.fetch(url+SWG_GRANT_ACCESS,{method:"POST",mode:"cors",credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(payload)}).then(function(response){return response.json()})["catch"](function(){console.error("Unknown error when creating account.");TWP.Identity.swgChecked=true})}function fetchWapoAcctMgmt(url){var uuid=$.cookie("wapo_login_id");
return window.fetch(url+WAPO_ACCT_MGMT_COOKIE+"/"+uuid,{method:"GET",credentials:"include",headers:{"Content-Type":"text/plain"}}).then(function(response){return response.text()})["catch"](function(){console.error("Unknown error when trying to access user's acct mgmt cookie.")})}function xhrWapoAcctMgmt(url){var uuid=$.cookie("wapo_login_id");var xhr=new XMLHttpRequest;xhr.open("POST",url+WAPO_ACCT_MGMT_COOKIE+"/"+uuid);xhr.setRequestHeader("Content-Type","text/plain");xhr.withCredentials=true;xhr.send();
return xhr}function buildSwgCheckEntitlementXHR(url,data){var xhr=new XMLHttpRequest;xhr.open("POST",url+SWG_CHECK_ENTITLEMENT);xhr.setRequestHeader("Content-Type","application/json");xhr.setRequestHeader("Accept","application/json");xhr.withCredentials=true;xhr.send(JSON.stringify(data));return xhr}function buildSwgGrantAccessXHR(url,data){var payload=transformPayload(data);var xhr=new XMLHttpRequest;xhr.open("POST",url+SWG_GRANT_ACCESS);xhr.setRequestHeader("Content-Type","application/json");xhr.setRequestHeader("Accept",
"application/json");xhr.withCredentials=true;xhr.send(JSON.stringify(payload));return xhr}function startSwgScript(){var s=document.createElement("script");s.type="text/javascript";s.setAttribute("subscriptions-control","manual");s.src="https://news.google.com/swg/js/v1/swg.js";s.onerror=function(){TWP.Identity.swgChecked=true;TWP.Identity._openOverlay()};$("head").append(s)}function reRenderIdntMenu(){if(typeof TWP.Util!=="undefined"&&typeof TWP.Util.User!=="undefined"){TWP.Util.User.init();var core=
window.wp_pb=window.wp_pb||{};var nav=core.nav=core.nav||{};if(typeof nav.getIdentityProvider==="function"){var prov=nav.getIdentityProvider();prov.render()}$("#nav-subscribe, #subscribe-left-nav, .nav-sign-in").addClass("hidden")}}function sendSWGOmniture(type,wapoAcctMgmtCookie){if(!!window.s&&typeof s.sendDataToOmniture=="function"){var uuid=$.cookie("wapo_login_id");var defaultOpts={eVar26:"invisible-sign-in",prop33:"google",eVar33:"google",eVar62:"logged out",prop70:"accountmanagement",eVar70:"accountmanagement"};
var opts={toastDeferredAccountCreation:{event:"event17",eVar1:"wp - id/login/lwg-consent",eVar26:"swg-linking-site",eVar59:uuid,prop59:uuid},consentToLinkOrCreate:{event:"event70",eVar26:"swg-linking-site",eVar1:"wp - id/login/lwg-consent",eVar62:"loggedIn",eVar59:uuid,prop59:uuid,eVar65:wapoAcctMgmtCookie,prop65:wapoAcctMgmtCookie},toastDeferredAccountCreationDeclined:{event:"event80",eVar1:"wp - id/login/lwg-consent-declined",eVar26:"swg-linking-site"},signedIn:{event:"event19",eVar1:"wp - id/login/lwg-success",
eVar59:uuid,prop59:uuid,eVar62:"logged in",eVar65:wapoAcctMgmtCookie,prop65:wapoAcctMgmtCookie}};var opt=opts[type];for(var key in defaultOpts)opt[key]=opt[key]||defaultOpts[key]||null;try{s.sendDataToOmniture(opt.eVar1,opt.event,opt)}catch(e){console.error(e)}}}return{init:init}};window.TWP_SWG().init()})(window.Zepto||window.jQuery);
(function($){window.console.log("Initialize USW");window.TWP=window.TWP||{};TWP.Identity=TWP.Identity||{};var showSignInWidget=function(){var isPWA=false;var signinUrl="https://www.washingtonpost.com/subscribe/signin/signin.html?tid\x3d"+TWP.Identity.uswTid;var originUrl="https://www.washingtonpost.com";if(window.location.host.indexOf("digitalink.com")!==-1){signinUrl="https://subscribe.digitalink.com/signin/signin.html?tid\x3d"+TWP.Identity.uswTid;originUrl="https://subscribe.digitalink.com"}else if(window.location.host.indexOf("pb-impact")!==
-1){signinUrl="https://www.washingtonpost.com/subscribe/stage/signin/signin.html?tid\x3d"+TWP.Identity.uswTid;originUrl="https://www.washingtonpost.com"}var jqConfig={url:signinUrl,overlay:'\x3cdiv id\x3d"wp_Signin" class\x3d"simple-overlay usw_Signin'+(isPWA?" is-pwa":"")+'"\x3e\x3cdiv class\x3d"usw-modal-content"\x3e\x3ciframe id\x3d"usw-iframe" src class\x3d"'+(isPWA?"is-pwa":"")+'" height\x3d"100%" width\x3d"100%" scrolling\x3d"'+(isPWA?"yes":"auto")+'" frameborder\x3d"0"\x3e\x3c/iframe\x3e\x3c/div\x3e\x3c/div\x3e',
overflowCss:"hidden",overlayConfig:{overlay:97,overlayClass:"wp_signin usw-signin"+(isPWA?" is-pwa":""),modal:true,closeClass:"usw-close-icon",toTop:true,trigger:".usw-close-icon",onShow:function(h){$("body").addClass("usw-modal-open");h.w.prependTo(h.o);if($(".pb-f-page-header-v2 .site-header.bar-hidden").length>0)$(".pb-f-page-header-v2 .site-header").removeClass("bar-hidden");h.o.css("z-index",1E11);h.w.css("z-index",100000000001);h.o.prependTo("body");if(typeof h.w.fadeIn=="function")h.w.fadeIn();
else h.w.show();setTimeout(function(){$("#wp_Signin").css("display","block");var uswIframe=document.getElementById("usw-iframe");uswIframe.removeAttribute("sandbox")},100);window.addEventListener("click",function(event){if(event.target===document.getElementsByClassName("usw-signin")[0])$overlay.jqmHide()},false);window.addEventListener("keyup",function(event){if(event.keyCode==27)$overlay.jqmHide()},false)},onHide:function(h){if(typeof h.w.fadeOut=="function")h.w.fadeOut("500",function(){h.o.remove()});
else{h.w.hide();h.o.remove()}$("body").removeClass("usw-modal-open")}}};TWP.Identity._loadModalCss();var $overlay=$(jqConfig.overlay);$overlay.jqm(jqConfig.overlayConfig);$overlay.find("iframe").attr("src",jqConfig.url);$overlay.jqmShow();function USWReceiveMessage(e){if(e.origin!==originUrl)return;if(e.data=="USW authenticated"){$overlay.jqmHide();if(window.TWP.originalUrl&&window.TWP.originalUrl!==window.location.href)window.location.href=window.TWP.originalUrl;else window.location.reload(true)}else if(e.data==
"USW close modal")$overlay.jqmHide()}window.addEventListener("message",USWReceiveMessage)};window.TWP.Identity.isUSWRegistered=false;function registerUSW(){if(!window.TWP.Identity.isUSWRegistered&&typeof $.fn.jqm!="undefined"){window.TWP.Identity.isUSWRegistered=true;$("#sign-in-link, #footer-signIn").click(function(event){event.preventDefault();if($(this).attr("id")=="sign-in-link")TWP.Identity.uswTid="usw_header";else if($(this).attr("id")==="footer-signIn")TWP.Identity.uswTid="usw_footer";TWP.Identity._showSignIn()})}}
TWP.Identity._showSignIn=showSignInWidget;_waitForElement("wp-header",function(){registerUSW()});function _waitForElement(elementId,callBack){var element=document.getElementById(elementId);if(element)callBack(elementId,element);else window.setTimeout(function(){var element=document.getElementById(elementId);if(element)callBack(elementId,element);else _waitForElement(elementId,callBack)},500)}})(window.Zepto||window.jQuery);