!function(){var e="undefined"!=typeof JSON&&"querySelector"in document&&"addEventListener"in window?"jquery_modern":"jquery_legacy";define("jquery",[e],function(){return jQuery})}(),define("modules/companion/companion-story-carousel",["jquery","underscore","utils","pubsub","modules/carousel/carousel","modules/carousel/gallery","modules/partner/companion-ad"],function(e,i,s,t,a,l,n){"use strict";var r=a.extend({initialize:function(s){i.bindAll(this,"refreshAdPosition"),this.pubSub=e.extend({"carousel:switchSlide":this.refreshAdPosition,"hor:scrollbar:update:compGalleryThumbs":this.lazyLoad},this.pubSub),a.prototype.initialize.call(this,s)},lazyLoad:function(){this.loaded||(s.lazyLoadImage(this.$(".thumb-image").slice(7)),this.loaded=!0)},_initializeGallery:function(e,i,s,t){this.subviews.gallery=new l({ads:s,el:t?this.$(t):this.$el,index:this.index,imageLazySrcAttr:e,slideTransition:i,carousel:this,isSideBarOpen:this.isSideBarOpen,triggerAdRefresh:!0,galleryClass:".companion-story-gallery"})},destroy:function(e){e&&this.$el.parent().remove(),a.prototype.destroy.call(this,!1)},setupAd:function(){var e,i=this.$el.data();i&&(e={},s.getNested(this.subviews.gallery)&&this.subviews.gallery.getAdTargeting()&&(e=this.subviews.gallery.getAdTargeting()),this.subviews.companionAd=new n({el:this.options.adSlot.children(".partner-placement"),targeting:e}),this.subviews.leaderboardAd=new n({el:this.$el.parent().find(".leaderboard-companion-ad"),targeting:e,adPlacement:"leaderboard_gallery_companion",adSizes:[728,90]}))},refreshAdPosition:function(){this.subviews.companionAd&&this.subviews.companionAd.throttledRefresh(),this.subviews.leaderboardAd&&this.subviews.leaderboardAd.throttledRefresh()}});return r}),define("apps/overlay/pages/story-overlay",["jquery","underscore","managers/routemanager","baseview","modules/companion/companion-story-carousel","pubsub","ui/loader","utils","modules/stories/share-facebook","modules/myCapture/myCapture"],function(e,i,s,t,a,l,n,r,o,d){"use strict";var h=t.extend({events:{"click .double-wide a":"processStoryLink","click .gallery-sidebar-close":"closeSidebar","click .fullscreen":"launchFullscreen","click .sidebar-gallery-btn":"launchGallery","click .gallery-util-bar-flyout-nav-btn":"onClickGalleryFlyoutNavBtn"},counter:10,initialize:function(s){this.$utility=e(".utility-bar-wrap"),this.$sharebar=e(".asset-inline-share-tools-bottom"),this.$rightad2=e(".partner-asset-right-ad-2"),this.$rightrail=e(".story-right-rail"),this.$closeoverlay=e(".close-overlay"),this.$overlayarrows=e(".overlay-arrows"),this.$storyimg=e(".single-photo.expandable-collapsed"),this.$index=0,this.$module=this.$(".companion-story-gallery"),this.$refreshing=!1,i.bindAll(this,"mouseScroll","mouseClick","sidebarAds","setupAd","refreshAd","openSidebar","closeSidebar","sidebarCaption","launchGallery"),this.pubSub=e.extend({"entered:view:compStoryGallery":this.lazyLoad},this.pubSub),t.prototype.initialize.call(this,s),this.$caption=new Array(this.$module.length),this.$sponsorshipAd=new Array(this.$module.length),this.$module.each(i.bind(function(i,s){var t,l=e(s),n=l.find(".gallery-sidebar-title").html();l.addClass("companion-story-gallery"+i),this.$caption[i]=l.find(".gallery-sidebar-panel .caption").html(),l.find(".photo-count").length||(t='<div class="gallery-hover"><div class="photo-count">'+l.find(".thumb-item").length+'&nbsp;Photos</div><div class="gallery-hover-title">'+n+'</div></div><div class="gallery-film inactive"></div>',l.find(".companion-galleries .gallery-photo-border:first").append(t),l.find(".companion-galleries").addClass("galleries")),this.subviews["facebook"+i]=new o({el:l.find(".gallery-sidebar-panel")}),this.subviews["gallery"+i]=new a({ads:!0,adSlot:l.find(".companion-galleries-partner-slot"),linkPath:l.find(".util-bar-flyout-nav-btn-facebook").data("share-link"),el:l.find(".companion-galleries"),fullScreen:!0,sidebarAds:this.sidebarAds})},this)),this.$galleryfilm=this.$(".gallery-film"),l.on("carousel:switchSlide",i.bind(function(e){e.hasClass("video-playlist-asset")||(e.find(".gallery-sidebar-panel").hasClass("active")||this.launchGallery(null,e),this.resetSections(),this.captionPoll=setInterval(this.sidebarCaption,200),this.refreshAd())},this)),this.setupAd(),this.$(".util-bar-flyout-section").hide(),this.$win=r.get("win"),this.$win.on("scroll."+this.cid,i.throttle(this.mouseScroll,1e3)),this.$win.on("click."+this.cid,this.mouseClick),this.resetAllButActive(),r.getNested(window.site_vars,"THIRDPARTYAPI","MYCAPTURE","ENABLED")&&!this.subviews.mycapture&&(this.subviews.mycapture=new d({el:this.$el,target:"js-mycapture-photo-asset"}))},lazyLoad:function(s){var t=e(s);r.lazyLoadImage(t.find(".gallery-photo-first")),r.lazyLoadImage(t.find(".thumb-image").slice(0,7)),this.$module.each(i.bind(function(i,s){e(s)},this))},_setupAds:function(){this.$module.each(i.bind(function(i,s){var t=e(s).find(".partner-placement.poster"),a=this.subviews["gallery"+i];if(!this.$sponsorshipAd[i]){if(t.length)return this.$sponsorshipAd[i]=t,void(t.hasClass("partner-placement-visible")&&!r.getNested(a,"subviews","companionAd")&&a.setupAd());this.$sponsorshipAd[i]=e('<div class="partner-placement poster" data-monetization-id="sp-gallery" data-monetization-sizes="mediumrectangle"></div>'),e(s).find(".companion-galleries-partner-slot").append(this.$sponsorshipAd[i])}},this))},_setCounterWidth:function(e){var s=e.find(".slide.active .gallery-photo").width();s?e.find(".gallery-hover").css({width:s}):(this.counter--,this.counter?setTimeout(i.bind(function(){this._setCounterWidth(e)},this),100):e.find(".gallery-hover").css({width:""}))},refreshAd:function(){this.$refreshing||(this.$refreshing=!0,this.subviews["sponsorshipAd"+this.$index]&&this.subviews["sponsorshipAd"+this.$index].refreshPosition&&this.subviews["sponsorshipAd"+this.$index].refreshPosition())},sidebarAds:function(){this.$module.each(i.bind(function(i,s){return i==this.$index?e(s).find(".gallery-sidebar-panel").hasClass("active")?!0:!1:void 0},this))},processStoryLink:function(i){if(!i.isDefaultPrevented()){var t=e(i.currentTarget);t.attr("target")||s.isAjax(t.attr("href"))||(t.attr("data-uotrack","storyinlinelink"),t.attr("target","_blank"))}},setupAd:function(){this.adSetup=!0,this._setupAds()},closeSidebar:function(s){s&&(s.preventDefault(),s.stopPropagation()),this.resetSections(),this.$(".sidebar-gallery-btn").addClass("active"),this.$module.each(i.bind(function(i,s){var t=e(s),a=t.find(".gallery-sidebar-panel");a.hasClass("active")&&(this.$(".util-bar-flyout-nav-btn").removeClass("active"),a.removeClass("active"),t.removeClass("active"),t.find(".companion-galleries").removeClass("active"),t.find(".gallery-sidebar-close").removeClass("active"),t.find(".gallery-sidebar-panel").removeClass("active"),t.parent().find(".card-film").addClass("inactive"),this.$galleryfilm.addClass("inactive"),this.$utility.css("z-index",101),this.$rightrail.show(),this.$rightad2.removeClass("hidden").removeClass("adFixed").css({position:"static",top:"auto"}),this.$closeoverlay.show(),this.$overlayarrows.show(),this.$storyimg.css("z-index",100),t.parent().parent().css("z-index","auto")),t.find(".slide.active").hasClass("endslate")&&this.subviews["gallery"+i].switchSlide(0)},this))},openSidebar:function(){this.$module.each(i.bind(function(i,s){var t=this.subviews["gallery"+i],a=e(s),l=a.find(".gallery-sidebar-panel");i==this.$index&&(l.hasClass("active")||(this.lazyLoadThumbs(a),a.addClass("active"),t.refreshAdPosition(),l.addClass("active"),this.$rightad2.addClass("hidden"),this.$rightrail.hide(),this.$closeoverlay.hide(),this.$overlayarrows.hide(),this.$storyimg.css("z-index",0),r.getNested(t,"subviews","companionAd")||this.subviews["gallery"+i].setupAd()))},this))},sidebarCaption:function(){this.resetSections(),this.$module.each(i.bind(function(i,s){var t=e(s),a=t.find(".gallery-sidebar-panel"),l=t.find(".gallery-sidebar-panel .caption"),n=t.find(".slide.active .gallery-viewport-caption").html();a.hasClass("active")?(n!=this.$caption[i]&&(this.$caption[i]=n,clearInterval(this.captionPoll),this.$refreshing=!1),n?l.html(n):l.empty()):l.html()||(l.html(n),l.scrollTop(0))},this))},mouseScroll:function(s){this.$module.each(i.bind(function(i,s){var t,a,l,n=e(s),r=n.find(".gallery-sidebar-close"),o=n.find(".gallery-sidebar-panel");o.hasClass("active")&&(t=o.outerHeight(),a=n.position().top,l=e(window).scrollTop(),(l+50>a+t||a>l+200)&&r.click())},this))},lazyLoadThumbs:function(e){r.lazyLoadImage(e.find(".thumb-image").slice(7))},mouseClick:function(s){var t=this.$module.length+1;this.$module.each(i.bind(function(i,a){var n,r,o,d,h=e(a),c=h.find(".gallery-sidebar-close"),u=h.find(".gallery-sidebar-panel");u.hasClass("active")&&(l.trigger("carousel:cardfilmActive"),n=h.offset().top,r=h.offset().left,o=h.outerWidth()+u.outerWidth(),d=u.outerHeight(),s.pageX<r||s.pageX>r+o||s.pageY<n||s.pageY>n+d?c.click():c.hasClass("active")||(h.parent().parent().css("z-index",200),this.$storyimg.css("z-index",0),c.addClass("active"),h.parent().find(".card-film").removeClass("inactive"),t=i))},this)),this.$module.each(function(i){i>t&&e(this).parent().find(".gallery-film").removeClass("inactive")})},launchFullscreen:function(s){s.preventDefault(),this.$module.each(i.bind(function(i,t){var a=e(t);s.currentTarget==a.find(".gallery-sidebar-panel.active .fullscreen")[0]&&l.trigger("openFullScreenCarousel",{carousel:this,fullScreen:!0,parent:a.find(".companion-galleries")})},this))},onClickGalleryFlyoutNavBtn:function(s){var t=e(s.currentTarget),a=t.data("share-method"),n=t.data("share-title"),r=t.data("share-link"),o="CompanionGallery"+a;l.trigger("uotrack",o),a&&this.showSection(t.parent().parent(),a),this.$module.each(i.bind(function(i,t){var l,o=e(t);i==this.$index&&(l=o.find(".gallery-sidebar-close"),l.hasClass("active")||(o.parent().parent().css("z-index",200),this.$storyimg.css("z-index",0),l.addClass("active"),o.parent().find(".card-film").removeClass("inactive")),"facebook"==a&&(o.find(".util-bar-success-link-facebook").each(function(){this.remove()}),o.find(".util-bar-share-message-facebook").data("link",r),o.find(".util-bar-share-message-facebook").data("title",n),o.find(".gallery-sidebar-panel .caption").empty(),this.subviews["facebook"+i].onClickPostBtn(s),s.preventDefault()))},this))},showSection:function(e,i){this.resetSections(),e.find(".util-bar-flyout-nav-btn-"+i).addClass("active")},resetSections:function(){this.$(".util-bar-flyout-nav-btn").removeClass("active"),this.$(".util-bar-flyout-pane-success").hide()},launchGallery:function(s,t){var a=t||e(s.currentTarget).parent().find(".companion-story-gallery"),l=a.find(".gallery-sidebar-close");s&&s.stopPropagation(),this.$(".sidebar-gallery-btn").removeClass("active"),l.addClass("active"),a.parent().find(".card-film").removeClass("inactive"),this.$module.each(i.bind(function(i,s){var t=e(s);s===a[0]&&(this.$index=i,this.$utility.css("z-index","auto"),this.$sharebar.hide(),t.find(".companion-galleries").addClass("active"),t.find(".gallery-sidebar-panel .partner-placement").css("display","block"),t.find(".util-bar-flyout-pane-success").is(":visible")||this.sidebarCaption(),this.openSidebar())},this))},resetAllButActive:function(){this.$module.each(i.bind(function(i,s){var t=e(s),a=t.find(".gallery-sidebar-panel");a.hasClass("active")||(this.$(".util-bar-flyout-nav-btn").removeClass("active"),t.removeClass("active"),t.find(".companion-galleries").removeClass("active"),t.find(".gallery-sidebar-close").removeClass("active"),t.find(".gallery-sidebar-panel").removeClass("active"),t.parent().find(".card-film").addClass("inactive"),this.$galleryfilm.addClass("inactive"))},this))}});return h});
//# sourceMappingURL=story-overlay.js.map